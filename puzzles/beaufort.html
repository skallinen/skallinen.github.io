<!DOCTYPE html>
<html lang="en" data-theme="dutch">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wind Speed Puzzle</title>

  <!-- Scittle + React + Scittle Reagent -->
  <script src="https://cdn.jsdelivr.net/npm/scittle@0.7.23/dist/scittle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/scittle@0.7.23/dist/scittle.reagent.js"></script>

  <style>
    /* =========================
       DESIGN TOKENS (Swiss / Helvetica)
       ========================= */
    :root{
      /* Layout */
      --footer-h: 64px;
      --footer-base-h: 64px;

      --radius-2: 2px;
      --radius-4: 4px;

      /* Typography */
      --font-sans: "Helvetica Now Text", "Neue Haas Grotesk Text",
                   "Helvetica Neue", Helvetica,
                   Inter, Roboto, Arial, sans-serif;
      --lh-tight: 1.25;
      --lh-base: 1.5;
      --ls-label: 0.06em;

      /* Neutrals */
      --ink:#0B0B0C;
      --text:#16181C;
      --subtext:#4B4F57;
      --border:#E6E7EA;
      --hairline:#EFF0F2;
      --canvas:#F7F8FA;
      --surface:#FFFFFF;

      /* Semantic */
      --success:#1A7F37;   --success-50:#EAF6EE;
      --warn:#B4690E;      --warn-50:#FFF3E0;
      --danger:#D92D20;    --danger-50:#FDECEC;

      /* Defaults (overridden by themes) */
      --accent-50:#EEF2FF;
      --accent-600:#2F49FF;

      /* Column cues (tints + strokes) – set per theme */
      --col-ms-tint:#EEF2FF;           --col-ms-stroke:#2F49FF;
      --col-knots-tint:#E8F5F2;        --col-knots-stroke:#0A7F5A;
      --col-kmh-tint:#FFF3E8;          --col-kmh-stroke:#B65A1E;
      --col-english-tint:#F2F4F7;      --col-english-stroke:#4B4F57;
      --col-finnish-tint:#EAF6EE;      --col-finnish-stroke:#1A7F37;
      --col-finnishModern-tint:#E6F4EF;--col-finnishModern-stroke:#0A7F5A;
      --col-swedish-tint:#F5ECF9;      --col-swedish-stroke:#6E2E8E;
      --col-sea-tint:#FFF8E7;          --col-sea-stroke:#B4690E;
    }

    /* =========================
       THEMES (palette variants)
       ========================= */

    [data-theme="neo"]{
      --accent-50:#EEF2FF; --accent-600:#2F49FF;
      --col-ms-tint:#EEF2FF;           --col-ms-stroke:#2F49FF;
      --col-knots-tint:#E9F6F2;        --col-knots-stroke:#0A7F5A;
      --col-kmh-tint:#FFF3E8;          --col-kmh-stroke:#B65A1E;
      --col-english-tint:#F2F4F7;      --col-english-stroke:#4B4F57;
      --col-finnish-tint:#EAF6EE;      --col-finnish-stroke:#1A7F37;
      --col-finnishModern-tint:#E6F4EF;--col-finnishModern-stroke:#0A7F5A;
      --col-swedish-tint:#F4ECFB;      --col-swedish-stroke:#6E2E8E;
      --col-sea-tint:#FFF8E7;          --col-sea-stroke:#B4690E;
    }

    [data-theme="radix"]{
      --accent-50:#F1EEFF; --accent-600:#6E56CF;
      --col-ms-tint:#F1EEFF;           --col-ms-stroke:#6E56CF;
      --col-knots-tint:#E9F8F1;        --col-knots-stroke:#2F9E44;
      --col-kmh-tint:#FFF7E6;          --col-kmh-stroke:#F59E0B;
      --col-english-tint:#F1F3F5;      --col-english-stroke:#475569;
      --col-finnish-tint:#ECFDF3;      --col-finnish-stroke:#16A34A;
      --col-finnishModern-tint:#E6FBF7;--col-finnishModern-stroke:#12A594;
      --col-swedish-tint:#F6EDFA;      --col-swedish-stroke:#AB4ABA;
      --col-sea-tint:#FFF4E5;          --col-sea-stroke:#F59E0B;
    }

    [data-theme="dazed"]{
      --accent-50:#FFE8F3; --accent-600:#FF1F8E;
      --col-ms-tint:#E9EDFF;            --col-ms-stroke:#1B50FF;
      --col-knots-tint:#E6FFF5;         --col-knots-stroke:#00C853;
      --col-kmh-tint:#FFF0E6;           --col-kmh-stroke:#FF6A00;
      --col-english-tint:#E6FAFF;       --col-english-stroke:#00D2FF;
      --col-finnish-tint:#FFE6F3;       --col-finnish-stroke:#FF1F8E;
      --col-finnishModern-tint:#F0E6FF; --col-finnishModern-stroke:#6E00FF;
      --col-swedish-tint:#FFF8DB;       --col-swedish-stroke:#B88600;
      --col-sea-tint:#FFE9EE;           --col-sea-stroke:#FF1744;
    }

    [data-theme="dutch"]{
      --accent-50:#E6EEFF; --accent-600:#0047FF;
      --col-ms-tint:#E6EEFF;            --col-ms-stroke:#0047FF;
      --col-knots-tint:#E6F7EF;         --col-knots-stroke:#00A85A;
      --col-kmh-tint:#FFF1E9;           --col-kmh-stroke:#FF5E1A;
      --col-english-tint:#F2E9FF;       --col-english-stroke:#7C2AE8;
      --col-finnish-tint:#FFE8EC;       --col-finnish-stroke:#E4002B;
      --col-finnishModern-tint:#FFE6F1; --col-finnishModern-stroke:#FF5DA2;
      --col-swedish-tint:#E6F7FF;       --col-swedish-stroke:#00B3FF;
      --col-sea-tint:#FFF6E0;           --col-sea-stroke:#FFB81C;
    }

    [data-theme="mono"]{
      --accent-50:#F8FAFC; --accent-600:#0B0B0C;
      --col-ms-tint:#F8FAFC;           --col-ms-stroke:#111827;
      --col-knots-tint:#F9FAFB;        --col-knots-stroke:#1F2937;
      --col-kmh-tint:#F6F7F9;          --col-kmh-stroke:#334155;
      --col-english-tint:#F3F4F6;      --col-english-stroke:#4B5563;
      --col-finnish-tint:#FAFAFB;      --col-finnish-stroke:#3F3F46;
      --col-finnishModern-tint:#F5F5F6;--col-finnishModern-stroke:#525252;
      --col-swedish-tint:#FAFAFA;      --col-swedish-stroke:#262626;
      --col-sea-tint:#F7F7F8;          --col-sea-stroke:#0F172A;
    }

    [data-theme="monowarm"]{
      --accent-50:#FAF7F4; --accent-600:#1C1917;
      --col-ms-tint:#FAF7F4;           --col-ms-stroke:#1C1917;
      --col-knots-tint:#F7F3F0;        --col-knots-stroke:#3F3A36;
      --col-kmh-tint:#F5F1ED;          --col-kmh-stroke:#57534E;
      --col-english-tint:#F8F4EF;      --col-english-stroke:#4A403A;
      --col-finnish-tint:#FBF6F0;      --col-finnish-stroke:#5B514B;
      --col-finnishModern-tint:#F7F3EF;--col-finnishModern-stroke:#2B2521;
      --col-swedish-tint:#F9F5F1;      --col-swedish-stroke:#6B6058;
      --col-sea-tint:#F6F2EE;          --col-sea-stroke:#332D27;
    }

    /* =========================
       Base / Page
       ========================= */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font-sans);
      color: var(--text);
      background: var(--canvas);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: 20px 20px calc(var(--footer-h) + 24px + env(safe-area-inset-bottom)) 20px;
    }
    body, table { font-variant-numeric: tabular-nums; }

    /* Type scale */
    h1{font-size:32px;line-height:40px;font-weight:600;margin:0 0 12px}
    .lead{color:var(--subtext)}
    .label{font-size:12px;line-height:16px;letter-spacing:var(--ls-label);text-transform:uppercase;color:var(--subtext);}

    /* Container */
    .container{
      max-width: 1400px;
      margin: 0 auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-4);
      padding: 24px;
      padding-bottom: calc(var(--footer-h) + 24px + env(safe-area-inset-bottom));
    }

    /* Instructions */
    .instructions{
      border:1px solid var(--border);
      background:#FAFBFD;
      border-radius: var(--radius-4);
      padding:16px 16px;
      margin-bottom:16px;
    }
    .instructions ol{margin:8px 0 0 18px}
    .instructions li{margin:6px 0}

    /* Selectors / Theme group */
    .selectors{
      display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;
      padding:12px 14px;margin-bottom:12px;border:1px solid var(--border);border-radius:var(--radius-4);background:var(--surface);
    }
    .selectors-left, .selectors-right{display:flex;flex-wrap:wrap;align-items:center;gap:10px}
    .selectors .group-title{font-weight:600;margin-right:6px}

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border);border-radius:var(--radius-2);
      padding:6px 10px;background:var(--surface);cursor:pointer;font-size:13px;font-weight:500;
      transition:background .15s ease, border-color .15s ease;
    }
    .chip:hover{background:#FAFAFC}
    .dot{width:8px;height:8px;border-radius:50%}
    .chip input{accent-color: var(--accent-600)}

    .theme-select{
      border:1px solid var(--border);border-radius:var(--radius-2);
      background:var(--surface);padding:6px 10px;font-weight:500;cursor:pointer;
    }

    /* Table */
    .table-container{overflow-x:auto;border-radius:var(--radius-4); margin-bottom:24px;}
    table{width:100%;border-collapse:collapse;background:var(--surface)}
    thead th{
      position:sticky;top:0;z-index:2;
      background:var(--surface);
      border-bottom:1px solid var(--border);
      padding:10px 8px;
      font-size:12px;letter-spacing:var(--ls-label);text-transform:uppercase;font-weight:600;color:var(--subtext);
      text-align:center;white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--hairline);
      padding:0;
      min-height:44px;vertical-align:middle;text-align:center;
    }
    tr:nth-child(even) td{background:#FCFCFD}

    .beaufort-badge{
      display:inline-block;
      border:1px solid var(--border);
      border-radius: var(--radius-2);
      padding:4px 8px;font-weight:600;margin:12px 0;
      background:#FAFAFC;color:var(--ink);
    }

    /* Drop zones */
    .drop-zone{
      position:relative;
      min-height:44px;display:flex;align-items:center;justify-content:center;
      border:1px dashed var(--border);border-radius: var(--radius-2);
      background: #FBFBFD; cursor:pointer; transition: background .15s ease, border-color .15s ease, transform .12s ease;
      margin:6px;
    }
    .drop-zone:hover{background:#F6F7FA}
    .drop-zone.filled{
      border-style:solid;
      margin:0;
    }

    /* Highlight tints for target column */
    .drop-zone.highlight[data-field="ms"]{background:var(--col-ms-tint);border-color:var(--col-ms-stroke)}
    .drop-zone.highlight[data-field="knots"]{background:var(--col-knots-tint);border-color:var(--col-knots-stroke)}
    .drop-zone.highlight[data-field="kmh"]{background:var(--col-kmh-tint);border-color:var(--col-kmh-stroke)}
    .drop-zone.highlight[data-field="english"]{background:var(--col-english-tint);border-color:var(--col-english-stroke)}
    .drop-zone.highlight[data-field="finnish"]{background:var(--col-finnish-tint);border-color:var(--col-finnish-stroke)}
    .drop-zone.highlight[data-field="finnish_modern"]{background:var(--col-finnishModern-tint);border-color:var(--col-finnishModern-stroke)}
    .drop-zone.highlight[data-field="swedish"]{background:var(--col-swedish-tint);border-color:var(--col-swedish-stroke)}
    .drop-zone.highlight[data-field="sea"]{background:var(--col-sea-tint);border-color:var(--col-sea-stroke)}

    .static-cell{
      min-height:44px;display:flex;align-items:center;justify-content:center;
      color:#9AA0A6;background:#FBFBFD;border:1px dashed transparent;border-radius:var(--radius-2);font-style:italic;margin:6px;
    }

    /* ====== FULL-CELL TILE ====== */
    .placed-tile{
      width:100%; height:100%;
      display:flex;align-items:center;justify-content:center;
      padding:12px 8px;
      border-radius: var(--radius-2);
      color:#fff;font-weight:600;border:0;
      user-select: none;
    }
    .placed-tile[data-field="ms"]{background:var(--col-ms-stroke)}
    .placed-tile[data-field="knots"]{background:var(--col-knots-stroke)}
    .placed-tile[data-field="kmh"]{background:var(--col-kmh-stroke)}
    .placed-tile[data-field="english"]{background:var(--col-english-stroke)}
    .placed-tile[data-field="finnish"]{background:var(--col-finnish-stroke)}
    .placed-tile[data-field="finnish_modern"]{background:var(--col-finnishModern-stroke)}
    .placed-tile[data-field="swedish"]{background:var(--col-swedish-stroke)}
    .placed-tile[data-field="sea"]{background:var(--col-sea-stroke)}

    /* ====== CHEAT OVERLAY (peek while pressed) ====== */
    .cheat-ghost{
      position:absolute; inset:0;
      display:flex;align-items:center;justify-content:center;
      border-radius:var(--radius-2);
      color:#fff; font-weight:600; opacity:.85;
      pointer-events:none;
    }
    .cheat-ghost[data-field="ms"]{background:var(--col-ms-stroke)}
    .cheat-ghost[data-field="knots"]{background:var(--col-knots-stroke)}
    .cheat-ghost[data-field="kmh"]{background:var(--col-kmh-stroke)}
    .cheat-ghost[data-field="english"]{background:var(--col-english-stroke)}
    .cheat-ghost[data-field="finnish"]{background:var(--col-finnish-stroke)}
    .cheat-ghost[data-field="finnish_modern"]{background:var(--col-finnishModern-stroke)}
    .cheat-ghost[data-field="swedish"]{background:var(--col-swedish-stroke)}
    .cheat-ghost[data-field="sea"]{background:var(--col-sea-stroke)}

    /* Footer (fixed) */
    .editor-footer{
      position:fixed;left:0;right:0;bottom:0;min-height: var(--footer-base-h);
      height: auto;
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding: 10px 20px calc(10px + env(safe-area-inset-bottom)) 20px;
      background: var(--surface);color: var(--text);
      border-top:1px solid var(--border);z-index:1000;
    }
    #footerTile{
      max-width: min(70vw, 520px);
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: break-word;
    }
    @media (min-width: 821px){
      #footerTile{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    }

    /* Mobile footer layout */
    @media (max-width:640px){
      .editor-footer{
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 8px 12px;
        padding: 10px 12px calc(10px + env(safe-area-inset-bottom)) 12px;
      }
      .editor-footer .footer-section{
        flex: 1 1 100%;
        flex-wrap: wrap;
        justify-content: space-between;
      }

      .footer-separator{ display:none; }
      button{ padding:6px 10px; }
      #footerTile{ max-width: 60vw; }
    }

    .editor-footer .footer-section{display:flex;align-items:center;gap:10px;flex-wrap:wrap;min-width:0}
    .footer-separator{color:var(--border)}
    .metric{font-variant-numeric: tabular-nums;}

    /* Buttons */
    button{
      border:1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      border-radius: var(--radius-2);
      padding:8px 12px;
      font-weight:500;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .1s ease;
    }
    button:hover{background:#FAFAFC}
    button:active{transform:translateY(1px)}
    .btn-primary{border-color: var(--accent-600);}
    .btn-danger{border-color: var(--danger); color: var(--danger);}

    /* Small animations */
    .pulse{animation:pulse .28s ease-in-out}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}

    @media (max-width:768px){
      .container{padding:16px}
      thead th, tbody td{padding:0}
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="application/x-scittle">
    (ns app.core
      (:require [reagent.core :as r]
                [reagent.dom  :as rdom]
                [clojure.string :as str]))

    ;; -----------------------
    ;; Data (EDN)
    ;; -----------------------
    (def beaufort-data
      [{:b 0  :knots "<1"   :ms "0-0.2"    :kmh "<1"    :english "Calm"
        :finnish "Tyyni" :finnish_modern "Tyyni" :swedish "Stiltje"
        :sea "Peilityyni meri."}
       {:b 1  :knots "1-3"  :ms "0.3-1.5"  :kmh "1-5"   :english "Light Air"
        :finnish "Hiljainen tuuli" :finnish_modern "Heikko tuuli" :swedish "Nästan stiltje"
        :sea "Meren pinnassa pieniä kareita, ei vaahtoa."}
       {:b 2  :knots "4-6"  :ms "1.6-3.3"  :kmh "6-11"  :english "Light Breeze"
        :finnish "Heikko tuuli" :finnish_modern "Heikko tuuli" :swedish "Lätt bris"
        :sea "Selkeitä mutta lyhyitä ja matalia aaltoja. Aallonharjat eivät murru."}
       {:b 3  :knots "7-10" :ms "3.4-5.4"  :kmh "12-19" :english "Gentle Breeze"
        :finnish "Heikonlainen tuuli" :finnish_modern "Kohtalainen tuuli" :swedish "God bris"
        :sea "Suurempia aaltoja; harvakseltaan vaahtoa."}
       {:b 4  :knots "11-16":ms "5.5-7.9"  :kmh "20-28" :english "Moderate Breeze"
        :finnish "Kohtalainen tuuli" :finnish_modern "Kohtalainen tuuli" :swedish "Frisk bris"
        :sea "Pitkähköjä aaltoja; valkoista vaahtoa."}
       {:b 5  :knots "17-21":ms "8.0-10.7" :kmh "29-38" :english "Fresh Breeze"
        :finnish "Navakka tuuli" :finnish_modern "Navakka tuuli" :swedish "Styv bris"
        :sea "Kohtalaisia, pitempiä aaltoja; vaahtopäitä."}
       {:b 6  :knots "22-27":ms "10.8-13.8":kmh "39-49" :english "Strong Breeze"
        :finnish "Kova tuuli" :finnish_modern "Navakka tuuli" :swedish "Hård bris"
        :sea "Kookkaita aaltoja; pärskettä."}
       {:b 7  :knots "28-33":ms "13.9-17.1":kmh "50-61" :english "Near Gale"
        :finnish "Luja tuuli" :finnish_modern "Kova tuuli" :swedish "Styv kuling"
        :sea "Vaahtopäät juoviksi, roiskeita."}
       {:b 8  :knots "34-40":ms "17.2-20.7":kmh "62-74" :english "Gale"
        :finnish "Myrskyinen tuuli" :finnish_modern "Kova tuuli" :swedish "Hård kuling"
        :sea "Korkeita ja pitkiä aaltoja, vaahtojuovia."}
       {:b 9  :knots "41-47":ms "20.8-24.4":kmh "75-88" :english "Severe Gale"
        :finnish "Myrsky" :finnish_modern "Myrsky" :swedish "Halv storm"
        :sea "Korkeita aaltoja; näkyvyys heikentyy."}
       {:b 10 :knots "48-55":ms "24.5-28.4":kmh "89-102":english "Storm"
        :finnish "Kova myrsky" :finnish_modern "Myrsky" :swedish "Storm"
        :sea "Erittäin korkeat aallot; näkyvyys heikko."}
       {:b 11 :knots "56-63":ms "28.5-32.6":kmh "103-117":english "Violent Storm"
        :finnish "Ankara myrsky" :finnish_modern "Myrsky" :swedish "Svår storm"
        :sea "Poikkeuksellisen korkeita aaltoja."}
       {:b 12 :knots "64+"  :ms ">32.7"    :kmh ">118" :english "Hurricane"
        :finnish "Hirmumyrsky" :finnish_modern "Hirmumyrsky" :swedish "Orkan"
        :sea "Ilma täynnä pärskettä; näkyvyys erittäin heikko."}])

    (def all-fields
      [{:key :ms             :label "m/s"              :dot "var(--col-ms-stroke)"}
       {:key :knots          :label "Knots"            :dot "var(--col-knots-stroke)"}
       {:key :kmh            :label "km/h"             :dot "var(--col-kmh-stroke)"}
       {:key :english        :label "English"          :dot "var(--col-english-stroke)"}
       {:key :finnish        :label "Suomi (vanha)"    :dot "var(--col-finnish-stroke)"}
       {:key :finnish_modern :label "Suomi (nykyinen)" :dot "var(--col-finnishModern-stroke)"}
       {:key :swedish        :label "Svenska"          :dot "var(--col-swedish-stroke)"}
       {:key :sea            :label "Vaikutus merellä" :dot "var(--col-sea-stroke)"}])

    ;; -----------------------
    ;; App state
    ;; -----------------------
    (defonce app-db
      (r/atom {:selected-fields #{:ms}
               :theme (keyword (or (.getItem js/localStorage "theme") "dutch"))
               :board {}                   ;; map of {[row field] -> value}
               :tiles []                   ;; vector of {:value v :field f :row r}
               :current-idx 0
               :attempts {:total 0 :correct 0}
               :timer {:elapsed-ms 0 :paused? false :start-ms (.now js/Date)}
               :cheat? false}))

    ;; Apply theme immediately
    (.setAttribute (.-documentElement js/document) "data-theme" (name (:theme @app-db)))

    ;; -----------------------
    ;; Helpers (pure)
    ;; -----------------------
    (defn fmt-mm-ss [ms]
      (let [s (long (/ ms 1000))
            m (long (/ s 60))
            ss (mod s 60)]
        (str (when (< m 10) "0") m ":" (when (< ss 10) "0") ss)))

    (defn fields-ordered [selected]
      (->> all-fields (map :key) (filter selected)))

    (defn tiles-for [selected]
      (->> beaufort-data
           (map-indexed
            (fn [row m]
              (for [f (fields-ordered selected)
                    :let [v (get m f)]
                    :when (and v (not (str/blank? (str v))))]
                {:value (str v) :field f :row row})))
           (apply concat)
           vec))

    (defn shuffle-tiles [v]
      (let [a (to-array v)]
        (loop [i (dec (alength a))]
          (when (> i 0)
            (let [j (rand-int (inc i))
                  vi (aget a i)
                  vj (aget a j)]
              (aset a i vj)
              (aset a j vi)
              (recur (dec i)))))
        (vec a)))

    (defn current-tile [db]
      (get (:tiles db) (:current-idx db)))

    (defn score-data [db]
      (let [{:keys [total correct]} (:attempts db)
            pct (if (pos? total) (Math/round (* 100 (/ correct total))) 0)]
        {:total total :correct correct :pct pct}))

    ;; -----------------------
    ;; Game mutations
    ;; -----------------------
    (defn init-game! [selected]
      (swap! app-db
             (fn [db]
               (let [t (-> selected tiles-for shuffle-tiles)]
                 (-> db
                     (assoc :selected-fields selected
                            :tiles t
                            :current-idx 0
                            :board {}
                            :attempts {:total 0 :correct 0}
                            :timer {:elapsed-ms 0
                                    :paused? false
                                    :start-ms (.now js/Date)}))))))

    ;; Safer explicit assoc (avoid tricky update/cond-> arities in SCI)
    (defn place-tile! [row field answer]
      (swap! app-db
             (fn [db]
               (let [t (current-tile db)
                     match? (and t (= (:field t) field) (= (:value t) answer))
                     cell   [:cell row field]
                     filled? (contains? (:board db) cell)]
                 (if (and match? (not filled?))
                   (let [board' (assoc (:board db) cell (:value t))]
                     (-> db
                         (update-in [:attempts :total] inc)
                         (update-in [:attempts :correct] inc)
                         (assoc :board board')
                         (update :current-idx inc)))
                   ;; wrong cell or already filled: only total attempts++
                   (update-in db [:attempts :total] inc))))))

    (defn remove-tile! [row field]
      (swap! app-db
             (fn [db]
               (let [cell [:cell row field]
                     val  (get-in db [:board cell])
                     tile {:value val :field field}
                     idx  (:current-idx db)
                     tiles (:tiles db)
                     insert-pos (+ idx (rand-int (max 1 (- (count tiles) idx))))
                     tiles* (-> []
                                (into (subvec tiles 0 insert-pos))
                                (conj tile)
                                (into (subvec tiles insert-pos)))
                     board' (dissoc (:board db) cell)]
                 (-> db
                     (assoc :tiles tiles* :board board')
                     (update-in [:attempts :correct] (fn [n] (max 0 (dec n)))))))))

    (defn toggle-pause! []
      (swap! app-db
             (fn [db]
               (let [paused? (not (get-in db [:timer :paused?]))]
                 (if paused?
                   (assoc-in db [:timer :paused?] true)
                   (-> db
                       (assoc-in [:timer :paused?] false)
                       (assoc-in [:timer :start-ms]
                                 (- (.now js/Date) (get-in db [:timer :elapsed-ms])))))))))

    (defn reset-game! []
      (init-game! (:selected-fields @app-db)))

    (defn set-theme! [k]
      (.setAttribute (.-documentElement js/document) "data-theme" (name k))
      (.setItem js/localStorage "theme" (name k))
      (swap! app-db assoc :theme k))

    ;; Cheat press & hold (self-removing listeners)
    (defn start-cheat! []
      (swap! app-db assoc :cheat? true)
      (letfn [(end []
                (swap! app-db assoc :cheat? false)
                (.removeEventListener js/window "pointerup" end)
                (.removeEventListener js/window "pointercancel" end)
                (.removeEventListener js/window "blur" end))]
        (.addEventListener js/window "pointerup" end)
        (.addEventListener js/window "pointercancel" end)
        (.addEventListener js/window "blur" end)))

    ;; -----------------------
    ;; Effects: timer + footer ResizeObserver
    ;; -----------------------
    (defonce timer-handle (atom nil))

    (defn start-timer! []
      (when @timer-handle (js/clearInterval @timer-handle))
      (reset! timer-handle
              (js/setInterval
               (fn []
                 (swap! app-db
                        (fn [db]
                          (if (get-in db [:timer :paused?])
                            db
                            (assoc-in db [:timer :elapsed-ms]
                                      (- (.now js/Date) (get-in db [:timer :start-ms])))))))
               1000)))

    (defn update-footer-height! []
      (when-let [el (.getElementById js/document "editorFooter")]
        (let [h (.-offsetHeight el)]
          (.setProperty (.-style (.-documentElement js/document))
                        "--footer-h" (str (or h 64) "px")))))

    (defonce footer-ro (atom nil))

    (defn mount-footer-ro! []
      (when @footer-ro (.disconnect @footer-ro))
      (when-let [RO (aget js/window "ResizeObserver")]
        (when-let [el (.getElementById js/document "editorFooter")]
          (let [ro (RO. (fn [_] (update-footer-height!)))]
            (.observe ro el)
            (reset! footer-ro ro)
            (update-footer-height!)))))

    ;; -----------------------
    ;; Components
    ;; -----------------------
    (defn header []
      [:header {:style {:margin-bottom "6px"}}
       [:h1 "Wind Speed"]
       [:p.lead "Fill the Beaufort scale table by placing the correct tiles into each selected column."]])

    (defn instructions []
      [:section.instructions
       [:div.label "Instructions"]
       [:ol
        [:li "Select which columns to include (Beaufort is always shown). Defaults: Beaufort + m/s."]
        [:li "One tile appears in the footer. Its color matches the target column."]
        [:li "Click any matching empty cell in that column to place it. If identical values appear in multiple rows, any matching row is accepted."]
        [:li [:strong "Cheat (hold):"] " press and hold to peek all correct answers; release to hide."]
        [:li "Score is " [:strong "correct tries ÷ total tries"] ". Timer runs only while active."]]])

    (defn selectors []
      (let [{:keys [selected-fields theme]} @app-db]
        [:div.selectors {:id "selectors"}
         [:div.selectors-left
          [:span.group-title "Columns:"]
          (for [{:keys [key label dot]} all-fields]
            ^{:key (str "chip-" (name key))}
            [:label.chip {:for (str "toggle-" (name key))}
             [:span.dot {:style {:background dot}}]
             [:input {:id (str "toggle-" (name key))
                      :type "checkbox"
                      :checked (contains? selected-fields key)
                      :on-change (fn [e]
                                   (let [checked (.. e -target -checked)
                                         new (if checked
                                               (conj selected-fields key)
                                               (disj selected-fields key))
                                         new (if (empty? new) selected-fields new)]
                                     (init-game! new)))}]
             [:span label]])]
         [:div.selectors-right {:id "themeGroup"}
          [:span.group-title "Theme:"]
          [:select.theme-select {:id "themeSelect"
                                 :aria-label "Theme"
                                 :value (name theme)
                                 :on-change (fn [e]
                                              (set-theme! (keyword (.. e -target -value))))}
           (for [k [:dutch :neo :radix :dazed :mono :monowarm]]
             ^{:key (str "opt-" (name k))}
             [:option {:value (name k)}
              (case k
                :dutch "Dutch Avant (default)"
                :neo "Neo Neutral"
                :radix "Radix Modern"
                :dazed "Dazed Neon"
                :mono "Mono Slate"
                :monowarm "Mono Warm")])]]]))

    (defn table-head []
      (let [fields (fields-ordered (:selected-fields @app-db))]
        [:thead {:id "tableHead"}
         [:tr
          [:th "Beaufort"]
          (for [f fields
                :let [meta (first (filter #(= (:key %) f) all-fields))]]
            ^{:key (str "th-" (name f))}
            [:th {:data-field (name f)}
             [:span {:style {:display "inline-flex"
                             :align-items "center"
                             :gap "8px"
                             :justify-content "center"}}
              [:span.dot {:style {:background (:dot meta)}}]
              [:span (:label meta)]]])]]))

    (defn drop-zone [row f value]
      (let [{:keys [board cheat?]} @app-db
            cell [:cell row f]
            filled? (contains? board cell)
            highlight? (when-let [t (current-tile @app-db)]
                         (and (= (:field t) f) (not filled?)))]
        [:td
         (if (and value (not (str/blank? (str value))))
           (let [classes (cond-> ["drop-zone"]
                           filled? (conj "filled")
                           highlight? (conj "highlight"))]
             [:div {:class (str/join " " classes)
                    :data-row row
                    :data-field (name f)
                    :on-click (fn [_]
                                (when-not filled?
                                  (place-tile! row f (str value))))
                    :style {:border-radius "var(--radius-2)"}}
              (when filled?
                [:div.placed-tile
                 {:data-field (name f)
                  :on-click (fn [e]
                              (.stopPropagation e)
                              (remove-tile! row f))}
                 (get board cell)])
              (when (and cheat? (not filled?))
                [:div.cheat-ghost {:data-field (name f)} (str value)])])
           [:div.static-cell "—"])]))

    (defn puzzle-table []
      (let [fields (fields-ordered (:selected-fields @app-db))]
        [:div.table-container
         [:table {:id "puzzleTable"}
          [table-head]
          [:tbody {:id "tableBody"}
           (for [[row m] (map-indexed vector beaufort-data)]
             ^{:key (str "row-" row)}
             [:tr
              [:td [:span.beaufort-badge (:b m)]]
              (for [f fields]
                ^{:key (str "cell-" row "-" (name f))}
                [drop-zone row f (get m f)])])]]]))

    (defn scroll-buffer []
      [:div.scroll-buffer {:aria-hidden "true"
                           :style {:height "calc(var(--footer-h) + env(safe-area-inset-bottom))"}}])

    (defn footer []
      (r/create-class
       {:display-name "footer"
        :component-did-mount (fn []
                               (start-timer!)
                               (mount-footer-ro!))
        :reagent-render
        (fn []
          (let [db @app-db
                t (current-tile db)
                prog (if (seq (:tiles db))
                       (str (inc (:current-idx db)) "/" (count (:tiles db)))
                       "0/0")
                {:keys [total correct pct]} (score-data db)]
            [:div.editor-footer {:id "editorFooter"}
             [:div.footer-section
              [:span.label {:style {:margin-right "6px"}} "Tile"]
              [:span.metric {:id "footerTile"
                             :style {:padding "6px 10px"
                                     :border "1px solid var(--border)"
                                     :border-radius "var(--radius-2)"
                                     :background "#FAFAFC"}}
               (or (:value t) "Ready")]
              [:span.footer-separator "|"]
              [:span.metric {:id "footerProgress"} prog]]
             [:div.footer-section
              [:span.label "Time"] [:span.metric {:id "footerTimer"} (fmt-mm-ss (get-in db [:timer :elapsed-ms]))]
              [:span.footer-separator "|"]
              [:span.label "Score"] [:span.metric {:id "footerScore"} (str correct "/" total " (" pct "%)")]
              [:span.footer-separator "|"]
              [:span.label "Tries"] [:span.metric {:id "footerAttempts"} total]]
             [:div.footer-section
              [:button.btn-primary {:id "footerPauseBtn"
                                    :on-click #(toggle-pause!)}
               (if (get-in db [:timer :paused?]) "Resume" "Pause")]
              [:button.btn-danger  {:on-click #(reset-game!)} "Reset"]
              [:button.btn-primary {:id "cheatBtn"
                                    :title "Press and hold to reveal answers"
                                    :on-pointer-down #(start-cheat!)} "Cheat (hold)"]]]))}))

    (defn root []
      [:div.container
       [header]
       [instructions]
       [selectors]
       [puzzle-table]
       [scroll-buffer]
       [footer]])

    ;; -----------------------
    ;; Mount + initial game
    ;; -----------------------
    (defn mount! []
      (rdom/render [root] (.getElementById js/document "app"))
      (init-game! (:selected-fields @app-db))
      (js/requestAnimationFrame (fn [] (update-footer-height!))))

    (mount!)
  </script>
</body>
</html>
